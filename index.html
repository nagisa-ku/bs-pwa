<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Book Search</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('Service Worker registered: ', registration);
          })
          .catch(error => {
            console.error('Service Worker registration failed: ', error);
          });
      });
    }
  </script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background: #f9f9f9;
    }
    input[type="file"],
    input[type="text"] {
      width: 100%;
      font-size: 16px;
      padding: 10px;
      margin-top: 1em;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      font-size: 13px;
      table-layout: fixed; /* ← 幅を固定するために必要！ */
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.4em 0.5em;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      background-color: #eee;
    }

    th.title, td.title {
      width: 125px; /* 全角8文字+… */
    }

    th.vol {
  width: 30px;
  text-align: center; /* ヘッダーは中央 */
    }

    td.vol {
  width: 30px;
  text-align: right;  /* データは右寄せ */
    }

    th.subtitle, td.subtitle {
      width: auto; /* 残りを割り当て */
    }

    @media (prefers-color-scheme: dark) {
      body { background: #111; color: #eee; }
      th, td { border-color: #444; }
      th { background-color: #222; }
    }
  </style>
</head>
<body>
  <h1>Book Search</h1>
  <input type="file" id="csvFile" accept=".csv" />
  <input type="text" id="search" placeholder="ISBN、タイトル、作者で検索" />
  <table id="results">
    <colgroup>
      <col class="title" />
      <col class="vol" />
      <col class="subtitle" />
    </colgroup>
    <thead>
      <tr>
        <th class="title">タイトル</th>
        <th class="vol">巻</th>
        <th class="subtitle">サブタイトル</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let books = [];

    // This function parses a single line of CSV text, respecting quoted fields.
    function parseCsvLine(line) {
        // Regex to handle quoted fields, escaped quotes, and commas.
        const regex = /(?:\"((?:[^\"]|\"\")*)\"|([^,]*))(,|$)/g;
        const fields = [];
        let match;
        // We need to reset lastIndex since we are using a global regex in a loop.
        regex.lastIndex = 0;
        // Guard against empty lines
        if (!line.trim()) {
            return [];
        }
        while (match = regex.exec(line)) {
            // If match[1] is not undefined, it's a quoted field.
            // We need to unescape the double quotes (\"\").
            let value = match[1] !== undefined ? match[1].replace(/\"\"/g, '"') : match[2];
            fields.push(value);
            // If the match doesn't end with a comma, we've reached the end of the line.
            if (match[3] === '') break;
        }
        return fields;
    }


    function processCsvText(text) {
        const lines = text.split('\n').filter(line => line.trim());
        books = lines.slice(1).map(line => {
            const [isbn, title, subtitle, vol, author] = parseCsvLine(line).map(s => s?.trim() || "");
            return { isbn, title, vol, subtitle, author };
        }).filter(b => b.isbn || b.title); // Filter out potentially empty rows
        displayBooks(books);
    }

    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, function(match) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[match];
        });
    }

    function displayBooks(data) {
      const tbody = document.querySelector('#results tbody');
      tbody.innerHTML = data.map(book => {
        const displayTitle = book.title.length > 8 ? book.title.slice(0, 8) + "…" : book.title;
        const escapedTitle = escapeHTML(book.title);
        const escapedSubtitle = escapeHTML(book.subtitle);
        return `
          <tr>
            <td class="title" title="${escapedTitle}">${escapeHTML(displayTitle)}</td>
            <td class="vol">${book.vol}</td>
            <td class="subtitle" title="${escapedSubtitle}">${escapeHTML(book.subtitle)}</td>
          </tr>`;
      }).join('');
    }

    function loadCSV(url) {
      fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(text => {
            processCsvText(text);
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
            // Optionally, display an error message to the user
            const tbody = document.querySelector('#results tbody');
            tbody.innerHTML = `<tr><td colspan="3">Error loading data. Please check the console.</td></tr>`;
        });
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          processCsvText(event.target.result);
        };
        reader.readAsText(file);
      }
    });

    document.getElementById('search').addEventListener('input', function() {
      const keyword = this.value.toLowerCase();
      const results = books.filter(book =>
        (book.isbn && book.isbn.toLowerCase().includes(keyword)) ||
        (book.title && book.title.toLowerCase().includes(keyword)) ||
        (book.author && book.author.toLowerCase().includes(keyword))
      );
      displayBooks(results);
    });

    window.addEventListener('DOMContentLoaded', () => {
      loadCSV('BaseData1.csv');
    });
  </script>
</body>
</html>
